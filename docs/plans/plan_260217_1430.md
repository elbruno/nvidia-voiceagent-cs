# Plan: Automated Testing & Validation for ASR Stability

**Date:** 2026-02-17  
**Time:** 14:30  
**Status:** Proposed

## 1. Objective

To automate the detection of runtime errors (specifically ONNX tensor shape mismatches and silent failure propagation) without manual application launching and debugging. This ensures the fix for `RuntimeException: [ONNXRuntimeError] : 1 : FAIL : Non-zero status code returned while running Add node` is verified and prevents regression.

## 2. Problem Statement

Two specific issues were identified during manual testing:

1. **ASR Silent Failure**: The ASR service returns `"[Transcription error]"`, which is treated as valid user input by the `VoiceWebSocketHandler`, causing "hallucinations" from the LLM.
2. **ASR Runtime Crash**: The `AsrService` throws an `OnnxRuntimeException` due to incorrect tensor shapes (specifically broadcasting errors on the `length` input) when running with the Parakeet-TDT model.

Manual verification requires:

1. Starting the full ASP.NET Core app.
2. Connecting a WebSocket client.
3. Speaking into a microphone.
4. Watching logs.

## 3. automation Strategy

We will implement a two-tiered testing approach:

### Tier 1: Unit/Logic Tests (Fast, No Model Required)

Code that orchestrates the pipeline or handles errors should be tested with mocks.

* **Target**: `NvidiaVoiceAgent.Core.Tests` and `NvidiaVoiceAgent.Tests`
* **Action**: Create `VoiceWebSocketHandlerTests.cs` (or extend existing) to verify error handling logic.
  * **Scenario**: Mock `IAsrService` to return `"[Transcription error]"`.
  * **Assertion**: Verify that `ProcessVoiceMessageAsync` (or equivalent pipeline step) **stops** processing and does *not* call `ILlmService`.

### Tier 2: Integration Tests (Real Model, Real Audio)

Code that interacts with ONNX Runtime must be tested with the real model to verify tensor shapes and compatibility.

* **Target**: `NvidiaVoiceAgent.Core.Tests`
* **Action**: Create `AsrServiceIntegrationTests.cs`.
  * **Prerequisite**: Requires the `parakeet-tdt-1.1b.onnx` (or configured model) to be present on disk.
  * **Configuration**: Use a custom `appsettings.Test.json` or Environment Variables to point to the model.
  * **Scenario**:
        1. Instantiate `AsrService` with real configuration.
        2. Load a valid 16kHz mono WAV file (sample provided in `tests/data/`).
        3. Call `TranscribeAsync`.
  * **Assertion**: Result is not null, not empty, and does *not* throw `OnnxRuntimeException`.

## 4. Implementation Steps

### Step 1: Create Test Data

Add a sample audio file to the repository for consistent testing.

* Location: `tests/data/sample_16k.wav`
* Content: A short (1-2s) voice command (e.g., "Hello world").

### Step 2: Implement `AsrServiceIntegrationTests`

Create a new test class in `NvidiaVoiceAgent.Core.Tests` that runs only if the model file exists (using `Skip` logic if missing).

```csharp
[Fact]
public async Task TranscribeAsync_WithRealModel_ReturnsText()
{
    // Arrange
    var config = new ModelConfig { ... }; // Point to real model path
    if (!File.Exists(config.AsrModelPath)) 
        return; // Skip if no model (CI/CD friendly)
        
    var service = new AsrService(logger, config);
    var audio = File.ReadAllBytes("tests/data/sample_16k.wav"); // Convert to float[]
    
    // Act
    var result = await service.TranscribeAsync(audioFloatArray);
    
    // Assert
    result.Should().NotBe("[Transcription error]");
    result.Should().NotBeNullOrEmpty();
}
```

### Step 3: Verify WebSocket Error Handling

Modify `Hubs/VoiceWebSocketHandler.cs` (already done) and add a test case to ensure the fix works.

## 5. Execution

Run the tests using `dotnet test`. This will:

1. Verify the ONNX tensor fix (via Integration Test).
2. Verify the logic fix (via Logic Test).

## 6. Next Steps

1. Approve this plan.
2. Generate the sample audio file (programmatically or download).
3. Write the test code.
