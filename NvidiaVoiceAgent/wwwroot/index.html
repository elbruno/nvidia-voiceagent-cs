<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVIDIA Voice Agent</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* CSS Variables for Theming */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111;
            --bg-tertiary: #141414;
            --bg-quaternary: #1a1a1a;
            --bg-header: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-card: #141414;
            --bg-input: #222;
            --bg-hover: #333;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --text-tertiary: #888;
            --text-quaternary: #666;
            --text-muted: #555;
            --border-primary: #222;
            --border-secondary: #333;
            --border-tertiary: #444;
            --border-quaternary: #555;
            --accent-primary: #76b900;
            --accent-secondary: #8fd400;
            --accent-tertiary: #5a8f00;
            --accent-gradient: linear-gradient(145deg, #76b900, #5a8f00);
            --error: #ef5350;
            --warning: #ffb74d;
            --info: #4fc3f7;
            --success: #76b900;
            --msg-user-bg: #1b3a1b;
            --msg-user-border: #76b900;
            --msg-user-text-bg: #1b3a1b;
            --msg-user-text-border: #4a8c00;
            --msg-agent-bg: #1a1a2e;
            --msg-agent-border: #4a4a6e;
            --msg-thinking-bg: #2a2a1e;
            --msg-thinking-border: #8a8a3e;
            --log-bg: #0d0d0d;
            --code-bg: #0a0a0a;
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafafa;
            --bg-quaternary: #eeeeee;
            --bg-header: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            --bg-card: #ffffff;
            --bg-input: #f0f0f0;
            --bg-hover: #e0e0e0;
            --text-primary: #212121;
            --text-secondary: #424242;
            --text-tertiary: #616161;
            --text-quaternary: #757575;
            --text-muted: #9e9e9e;
            --border-primary: #e0e0e0;
            --border-secondary: #d0d0d0;
            --border-tertiary: #bdbdbd;
            --border-quaternary: #9e9e9e;
            --accent-primary: #76b900;
            --accent-secondary: #8fd400;
            --accent-tertiary: #5a8f00;
            --accent-gradient: linear-gradient(145deg, #76b900, #5a8f00);
            --error: #d32f2f;
            --warning: #f57c00;
            --info: #0288d1;
            --success: #76b900;
            --msg-user-bg: #e8f5e9;
            --msg-user-border: #76b900;
            --msg-user-text-bg: #f1f8e9;
            --msg-user-text-border: #8bc34a;
            --msg-agent-bg: #e3f2fd;
            --msg-agent-border: #64b5f6;
            --msg-thinking-bg: #fff9c4;
            --msg-thinking-border: #fbc02d;
            --log-bg: #fafafa;
            --code-bg: #f5f5f5;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        header {
            width: 100%;
            padding: 1rem 2rem;
            background: var(--bg-header);
            border-bottom: 2px solid var(--accent-primary);
            text-align: center;
            flex-shrink: 0;
        }
        header h1 {
            font-size: 1.6rem;
            color: var(--accent-primary);
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        header p {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            flex-shrink: 0;
            gap: 0.75rem;
        }
        .theme-selector {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .theme-selector label {
            color: var(--text-tertiary);
        }
        .theme-selector select {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-tertiary);
            border-radius: 6px;
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .theme-selector select:hover {
            background: var(--bg-hover);
        }
        #status {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
        }
        .connected { color: var(--success); border: 1px solid var(--success); }
        .disconnected { color: var(--error); border: 1px solid var(--error); }
        .recording { color: var(--warning); border: 1px solid var(--warning); }
        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .model-select {
            display: none;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .model-select.visible { display: flex; }
        .model-select label { color: var(--text-tertiary); }
        .model-select select {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-tertiary);
            border-radius: 6px;
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--border-tertiary);
            border-radius: 22px;
            transition: 0.3s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-tertiary);
            border-radius: 50%;
            transition: 0.3s;
        }
        .switch input:checked + .slider { background-color: var(--accent-primary); }
        .switch input:checked + .slider:before { transform: translateX(18px); background-color: var(--bg-secondary); }
        .container {
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            padding: 0 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 0;
        }
        .chat-box {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .msg {
            padding: 0.75rem 1rem;
            border-radius: 10px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .msg.user {
            background: var(--msg-user-bg);
            border: 1px solid var(--msg-user-border);
            align-self: flex-end;
        }
        .msg.user-text {
            background: var(--msg-user-text-bg);
            border: 1px solid var(--msg-user-text-border);
            align-self: flex-end;
            font-style: italic;
            opacity: 0.85;
        }
        .msg.agent {
            background: var(--msg-agent-bg);
            border: 1px solid var(--msg-agent-border);
            align-self: flex-start;
        }
        .msg.thinking {
            background: var(--msg-thinking-bg);
            border: 1px solid var(--msg-thinking-border);
            align-self: flex-start;
            opacity: 0.7;
            font-style: italic;
        }
        .msg .label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
            color: var(--accent-primary);
        }
        .msg.agent .label { color: var(--info); }
        .msg.thinking .label { color: var(--warning); }
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            flex-shrink: 0;
        }
        .model-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            padding: 0.4rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-primary);
            cursor: pointer;
        }
        .model-status:hover { background: var(--bg-quaternary); }
        .model-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .model-status .dot.ready { background: var(--success); }
        .model-status .dot.loading { background: var(--warning); animation: blink 1s infinite; }
        .model-status .dot.missing { background: var(--error); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Models Panel */
        .models-panel {
            width: 100%;
            background: var(--log-bg);
            border-bottom: 2px solid var(--border-secondary);
            flex-shrink: 0;
            display: none;
        }
        .models-panel.visible { display: block; }
        .models-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
        }
        .models-panel-header h2 {
            font-size: 0.8rem;
            color: var(--accent-primary);
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        .models-panel-close {
            background: var(--bg-input);
            color: var(--text-tertiary);
            border: 1px solid var(--border-tertiary);
            border-radius: 4px;
            padding: 0.1rem 0.5rem;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .models-panel-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        .models-panel-body {
            padding: 0.5rem 1rem;
        }
        .model-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            margin-bottom: 0.4rem;
        }
        .model-card:last-child { margin-bottom: 0; }
        .model-card-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }
        .model-card-info {
            flex: 1;
            min-width: 0;
        }
        .model-card-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .model-card-name .model-type-badge {
            display: inline-block;
            background: var(--msg-agent-bg);
            color: var(--info);
            font-size: 0.6rem;
            font-weight: 700;
            padding: 0.1rem 0.35rem;
            border-radius: 4px;
            margin-left: 0.4rem;
            text-transform: uppercase;
            vertical-align: middle;
        }
        .model-card-meta {
            font-size: 0.68rem;
            color: var(--text-tertiary);
            margin-top: 0.2rem;
            line-height: 1.4;
        }
        .model-card-meta a {
            color: var(--info);
            text-decoration: none;
        }
        .model-card-meta a:hover { text-decoration: underline; }
        .model-card-path {
            font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            font-size: 0.65rem;
            color: var(--accent-primary);
            background: var(--code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            margin-top: 0.25rem;
            word-break: break-all;
            display: none;
        }
        .model-card-path.visible { display: block; }
        .model-card-status {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .model-card-status .status-badge {
            font-size: 0.68rem;
            font-weight: 600;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            white-space: nowrap;
        }
        .status-badge.downloaded {
            color: var(--success);
            border: 1px solid var(--success);
            background: rgba(118, 185, 0, 0.1);
        }
        .status-badge.not-downloaded {
            color: var(--error);
            border: 1px solid var(--error);
            background: rgba(239, 83, 80, 0.1);
        }
        .status-badge.downloading {
            color: var(--warning);
            border: 1px solid var(--warning);
            background: rgba(255, 183, 77, 0.1);
        }
        .model-download-btn {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            border: 1px solid var(--info);
            background: rgba(79, 195, 247, 0.1);
            color: var(--info);
            cursor: pointer;
            white-space: nowrap;
        }
        .model-download-btn:hover {
            background: rgba(79, 195, 247, 0.25);
        }
        .model-download-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .model-delete-btn {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            border: 1px solid var(--error);
            background: rgba(239, 83, 80, 0.1);
            color: var(--error);
            cursor: pointer;
            white-space: nowrap;
        }
        .model-delete-btn:hover {
            background: rgba(239, 83, 80, 0.25);
        }
        .model-delete-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .model-coming-soon {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            border: 1px solid var(--border-quaternary);
            background: rgba(100, 100, 100, 0.15);
            color: var(--text-tertiary);
            white-space: nowrap;
        }
        .model-card-progress {
            margin-top: 0.35rem;
            display: none;
        }
        .model-card-progress.visible { display: block; }
        .progress-bar-bg {
            width: 100%;
            height: 6px;
            background: var(--border-primary);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-text {
            font-size: 0.62rem;
            color: var(--text-tertiary);
            margin-top: 0.15rem;
            text-align: right;
        }
        .clear-chat-btn {
            background: var(--bg-hover);
            color: var(--text-secondary);
            border: 1px solid var(--border-quaternary);
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .clear-chat-btn:hover { background: var(--border-tertiary); color: var(--text-primary); }
        #talkBtn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--accent-gradient);
            border: 3px solid var(--accent-primary);
            color: var(--bg-secondary);
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            line-height: 1.3;
            user-select: none;
            -webkit-user-select: none;
        }
        #talkBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(118, 185, 0, 0.3);
        }
        #talkBtn.recording {
            background: linear-gradient(145deg, var(--error), #c62828);
            border-color: var(--bg-secondary);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(118, 185, 0, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(118, 185, 0, 0); }
        }
        .info {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            flex-shrink: 0;
            padding-bottom: 0.25rem;
        }
        .log-panel {
            width: 100%;
            background: var(--log-bg);
            border-top: 2px solid var(--border-secondary);
            flex-shrink: 0;
        }
        .log-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 1rem;
            background: var(--bg-tertiary);
            cursor: pointer;
            user-select: none;
        }
        .log-header:hover { background: var(--bg-quaternary); }
        .log-header h2 {
            font-size: 0.8rem;
            color: var(--accent-primary);
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        .log-header .log-toggle {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        .log-header .log-badge {
            background: var(--accent-primary);
            color: var(--bg-primary);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.1rem 0.45rem;
            border-radius: 10px;
            margin-left: 0.5rem;
            display: none;
        }
        .log-body {
            height: 130px;
            overflow-y: auto;
            padding: 0.3rem 0.75rem;
            font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            font-size: 0.72rem;
            line-height: 1.5;
        }
        .log-body.collapsed {
            height: 0;
            padding: 0 0.75rem;
            overflow: hidden;
        }
        .log-entry {
            display: flex;
            gap: 0.5rem;
            padding: 0.1rem 0;
            border-bottom: 1px solid var(--bg-quaternary);
        }
        .log-entry:last-child { border-bottom: none; }
        .log-ts { color: var(--text-muted); white-space: nowrap; }
        .log-level { font-weight: 700; white-space: nowrap; min-width: 3.5em; }
        .log-level.INFO { color: var(--info); }
        .log-level.WARN { color: var(--warning); }
        .log-level.ERROR { color: var(--error); }
        .log-msg { color: var(--text-secondary); word-break: break-word; flex: 1; }
        .log-detail-toggle {
            color: var(--accent-primary);
            cursor: pointer;
            font-size: 0.65rem;
            white-space: nowrap;
        }
        .log-detail {
            display: none;
            padding: 0.25rem 0.5rem;
            margin: 0.1rem 0 0.2rem 4.5rem;
            background: var(--bg-quaternary);
            border-radius: 4px;
            color: var(--text-tertiary);
            font-size: 0.68rem;
            white-space: pre-wrap;
        }
        .log-detail.open { display: block; }
        .log-clear-btn {
            background: var(--bg-input);
            color: var(--text-tertiary);
            border: 1px solid var(--border-tertiary);
            border-radius: 4px;
            padding: 0.1rem 0.4rem;
            font-size: 0.65rem;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        .log-clear-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    </style>
</head>
<body>
    <header>
        <h1>üéôÔ∏è NVIDIA Voice Agent</h1>
        <p>Parakeet ASR ¬∑ FastPitch + HiFiGAN TTS ¬∑ Phi-3 Smart Mode (C# Port)</p>
    </header>

    <div class="top-bar">
        <div id="status" class="disconnected">Disconnected</div>
        <div class="model-status" id="modelStatus">
            <span class="dot loading" id="modelDot"></span>
            <span id="modelStatusText">Checking models‚Ä¶</span>
        </div>
        <div class="theme-selector">
            <label for="themePicker">üé® Theme</label>
            <select id="themePicker">
                <option value="system">System</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
            </select>
        </div>
        <div class="model-select" id="modelSelect">
            <label for="modelPicker">Model</label>
            <select id="modelPicker">
                <option value="tinyllama">TinyLlama 1.1B (fast)</option>
                <option value="phi3">Phi-3 Mini 3.8B (better)</option>
                <option value="personaplex">PersonaPlex 7B (TTS+LLM)</option>
            </select>
        </div>
        <div class="mode-toggle">
            <span>Smart Mode</span>
            <label class="switch">
                <input type="checkbox" id="smartMode">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="models-panel" id="modelsPanel">
        <div class="models-panel-header">
            <h2>üß† Models</h2>
            <button class="models-panel-close" id="modelsPanelClose">‚úï Close</button>
        </div>
        <div class="models-panel-body" id="modelsPanelBody">
            <div style="color:#666;font-size:0.75rem;padding:0.5rem 0;">Loading model info‚Ä¶</div>
        </div>
    </div>

    <div class="container">
        <div class="chat-box" id="chatBox"></div>
        <div class="controls">
            <button class="clear-chat-btn" id="clearChatBtn">‚úï Clear</button>
            <button id="talkBtn">Hold to<br>Talk</button>
        </div>
        <div class="info">Press and hold the button to record ¬∑ Release to send</div>
    </div>

    <div class="log-panel">
        <div class="log-header" id="logHeader">
            <h2>üìã Server Log <span class="log-badge" id="logBadge">0</span></h2>
            <div style="display:flex;align-items:center;">
                <button class="log-clear-btn" id="logClearBtn">Clear</button>
                <span class="log-toggle" id="logToggle">‚ñ≤</span>
            </div>
        </div>
        <div class="log-body" id="logBody"></div>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const talkBtn = document.getElementById('talkBtn');
        const statusEl = document.getElementById('status');
        const logBody = document.getElementById('logBody');
        const logHeader = document.getElementById('logHeader');
        const logToggle = document.getElementById('logToggle');
        const logBadge = document.getElementById('logBadge');
        const logClearBtn = document.getElementById('logClearBtn');
        const smartModeToggle = document.getElementById('smartMode');
        const modelSelectDiv = document.getElementById('modelSelect');
        const modelPicker = document.getElementById('modelPicker');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const modelStatusEl = document.getElementById('modelStatus');
        const modelDot = document.getElementById('modelDot');
        const modelStatusText = document.getElementById('modelStatusText');
        const modelsPanel = document.getElementById('modelsPanel');
        const modelsPanelBody = document.getElementById('modelsPanelBody');
        const modelsPanelClose = document.getElementById('modelsPanelClose');
        const themePicker = document.getElementById('themePicker');

        let ws = null;
        let logWs = null;
        let mediaRecorder = null;
        let logCount = 0;
        let logCollapsed = false;
        let smartMode = false;
        let modelsData = []; // cached model data from API

        // ========== Theme Management ==========
        const systemThemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
        
        function getSystemTheme() {
            return systemThemeQuery.matches ? 'dark' : 'light';
        }
        
        function applyTheme(theme) {
            let effectiveTheme = theme;
            if (theme === 'system') {
                effectiveTheme = getSystemTheme();
            }
            
            if (effectiveTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }
        
        themePicker.addEventListener('change', () => {
            const theme = themePicker.value;
            localStorage.setItem('theme', theme);
            applyTheme(theme);
            clientLog(`Theme changed to: ${theme}`);
        });
        
        // Listen for system theme changes when using 'system' theme
        systemThemeQuery.addEventListener('change', (e) => {
            if (themePicker.value === 'system') {
                applyTheme('system');
                clientLog(`System theme changed to: ${e.matches ? 'dark' : 'light'}`);
            }
        });
        
        // Initialize theme early (will be logged once clientLog is available)
        const initialTheme = localStorage.getItem('theme') || 'system';
        themePicker.value = initialTheme;
        applyTheme(initialTheme);
        // ========== End Theme Management ==========

        clearChatBtn.addEventListener('click', () => {
            chatBox.innerHTML = '';
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'clear_history' }));
            }
            clientLog('Chat cleared (models stay loaded)');
        });

        function sendSmartModeConfig() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'config',
                    smart_mode: smartModeToggle.checked,
                    smart_model: modelPicker.value
                }));
            }
        }
        smartModeToggle.addEventListener('change', () => {
            smartMode = smartModeToggle.checked;
            modelSelectDiv.classList.toggle('visible', smartMode);
            clientLog(`Smart Mode ${smartMode ? 'enabled' : 'disabled'}`);
            sendSmartModeConfig();
        });
        modelPicker.addEventListener('change', () => {
            clientLog(`Model changed to: ${modelPicker.options[modelPicker.selectedIndex].text}`);
            sendSmartModeConfig();
        });

        logHeader.addEventListener('click', (e) => {
            if (e.target === logClearBtn) return;
            logCollapsed = !logCollapsed;
            logBody.classList.toggle('collapsed', logCollapsed);
            logToggle.textContent = logCollapsed ? '‚ñº' : '‚ñ≤';
        });
        logClearBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            logBody.innerHTML = '';
            logCount = 0;
            logBadge.style.display = 'none';
        });

        function connectLogs() {
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            logWs = new WebSocket(`${proto}://${location.host}/ws/logs`);
            logWs.onmessage = (event) => {
                const entry = JSON.parse(event.data);
                appendLog(entry.timestamp, entry.level, entry.message, entry.detail || '');
                updateModelStatusFromLog(entry.message);
            };
            logWs.onclose = () => setTimeout(connectLogs, 3000);
            logWs.onerror = () => logWs.close();
        }

        function appendLog(ts, level, msg, detail) {
            const wrapper = document.createElement('div');
            const row = document.createElement('div');
            row.className = 'log-entry';
            const tsEl = document.createElement('span');
            tsEl.className = 'log-ts';
            tsEl.textContent = ts;
            const lvlEl = document.createElement('span');
            lvlEl.className = `log-level ${level}`;
            lvlEl.textContent = level;
            const msgEl = document.createElement('span');
            msgEl.className = 'log-msg';
            msgEl.textContent = msg;
            row.appendChild(tsEl);
            row.appendChild(lvlEl);
            row.appendChild(msgEl);
            if (detail) {
                const toggle = document.createElement('span');
                toggle.className = 'log-detail-toggle';
                toggle.textContent = '‚ñ∂ details';
                row.appendChild(toggle);
                const detailEl = document.createElement('div');
                detailEl.className = 'log-detail';
                detailEl.textContent = detail;
                toggle.addEventListener('click', () => {
                    const open = detailEl.classList.toggle('open');
                    toggle.textContent = open ? '‚ñº details' : '‚ñ∂ details';
                });
                wrapper.appendChild(row);
                wrapper.appendChild(detailEl);
            } else {
                wrapper.appendChild(row);
            }
            logBody.appendChild(wrapper);
            logBody.scrollTop = logBody.scrollHeight;
            logCount++;
            logBadge.textContent = logCount;
            logBadge.style.display = 'inline';
            while (logBody.children.length > 200) {
                logBody.removeChild(logBody.firstChild);
            }
        }

        function clientLog(msg) {
            const ts = new Date().toLocaleTimeString('en-GB', { hour12: false });
            appendLog(ts, 'INFO', msg);
        }

        connectLogs();
        
        // Log initial theme after logging is ready
        setTimeout(() => {
            clientLog(`Theme initialized: ${themePicker.value}`);
        }, 100);

        // --- Models Panel ---
        modelStatusEl.addEventListener('click', () => {
            modelsPanel.classList.toggle('visible');
            if (modelsPanel.classList.contains('visible')) fetchModels();
        });
        modelsPanelClose.addEventListener('click', () => {
            modelsPanel.classList.remove('visible');
        });

        async function fetchModels() {
            try {
                const resp = await fetch('/api/models');
                modelsData = await resp.json();
                renderModelsPanel();
            } catch (e) {
                modelsPanelBody.innerHTML = '<div style="color:#ef5350;font-size:0.75rem;padding:0.5rem 0;">Failed to load model info.</div>';
            }
        }

        function renderModelsPanel() {
            modelsPanelBody.innerHTML = '';
            if (!modelsData.length) {
                modelsPanelBody.innerHTML = '<div style="color:#666;font-size:0.75rem;padding:0.5rem 0;">No models registered.</div>';
                return;
            }
            modelsData.forEach((m, idx) => {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.id = `model-card-${idx}`;

                const statusClass = m.status === 'downloaded' ? 'downloaded'
                    : m.status === 'downloading' ? 'downloading'
                    : 'not-downloaded';
                const statusLabel = m.status === 'downloaded' ? '‚úÖ Downloaded'
                    : m.status === 'downloading' ? 'üì• Downloading'
                    : '‚ùå Not Downloaded';
                const sizeMb = m.expectedSizeMb.toFixed(1);
                const tokenConfigured = m.huggingFaceTokenConfigured || false;
                const showDownloadBtn = m.status !== 'downloaded' && m.isAvailableForDownload;
                const showComingSoon = m.status !== 'downloaded' && !m.isAvailableForDownload;
                const showDeleteBtn = m.status === 'downloaded';
                const requiresAuth = m.requiresAuthentication || false;
                const showAuthWarning = requiresAuth && !tokenConfigured && m.status !== 'downloaded';
                const downloadLocked = requiresAuth && !tokenConfigured;
                const downloadLabel = downloadLocked ? 'üîí Token required' : '‚¨á Download';

                card.innerHTML = `
                    <div class="model-card-row">
                        <div class="model-card-info">
                            <div class="model-card-name">${esc(m.name)} <span class="model-type-badge">${esc(m.type)}</span></div>
                            <div class="model-card-meta">
                                <a href="https://huggingface.co/${esc(m.repoId)}" target="_blank" rel="noopener">${esc(m.repoId)}</a>
                                &nbsp;¬∑&nbsp;${sizeMb} MB${m.isRequired ? ' ¬∑ <strong>required</strong>' : ''}
                                ${requiresAuth ? (tokenConfigured
                                    ? ' ¬∑ <span style="color:var(--success)">üîê HF Token configured</span>'
                                    : ' ¬∑ <span style="color:var(--warning)">üîê Requires HF Token</span>') : ''}
                            </div>
                        </div>
                        <div class="model-card-status">
                            ${showDownloadBtn ? `<button class="model-download-btn" id="model-dl-btn-${idx}" data-locked="${downloadLocked}" ${downloadLocked ? 'disabled' : ''} onclick="downloadModel('${esc(m.name)}', ${idx})">${downloadLabel}</button>` : ''}
                            ${showComingSoon ? '<span class="model-coming-soon">üîú Coming Soon</span>' : ''}
                            ${showDeleteBtn ? `<button class="model-delete-btn" id="model-del-btn-${idx}" onclick="deleteModel('${esc(m.name)}', ${idx})">üóëÔ∏è Delete</button>` : ''}
                            <span class="status-badge ${statusClass}" id="model-badge-${idx}">${statusLabel}</span>
                        </div>
                    </div>
                    ${showAuthWarning ? `
                    <div style="background:rgba(255,183,77,0.1);border:1px solid var(--warning);border-radius:4px;padding:0.5rem;margin-top:0.5rem;font-size:0.75rem;line-height:1.4;">
                        <strong>‚ö†Ô∏è Authentication Required</strong><br/>
                        This gated model requires a HuggingFace token. 
                        <a href="https://github.com/elbruno/nvidia-voiceagent-cs/blob/main/docs/guides/huggingface-token-setup.md" target="_blank" style="color:var(--accent-secondary)">Setup guide</a>
                    </div>
                    ` : ''}
                    <div class="model-card-path ${m.localPath ? 'visible' : ''}" id="model-path-${idx}">${m.localPath ? esc(m.localPath) : ''}</div>
                    <div class="model-card-progress" id="model-progress-${idx}">
                        <div class="progress-bar-bg"><div class="progress-bar-fill" id="model-bar-${idx}"></div></div>
                        <div class="progress-text" id="model-pct-${idx}"></div>
                    </div>
                `;
                modelsPanelBody.appendChild(card);
            });
        }

        function esc(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function updateModelStatusFromLog(msg) {
            if (!msg) return;
            // Match download progress: "Downloading Parakeet-TDT-0.6B-V2: 45.0% (1200.0/2541.7 MB)"
            const progressMatch = msg.match(/Downloading (.+?):\s*([\d.]+)%\s*\(([\d.]+)\/([\d.]+)\s*MB\)/);
            if (progressMatch) {
                const modelName = progressMatch[1];
                const pct = parseFloat(progressMatch[2]);
                const dlMb = progressMatch[3];
                const totalMb = progressMatch[4];
                // Update top-bar indicator
                modelDot.className = 'dot loading';
                modelStatusText.textContent = `Downloading‚Ä¶ ${pct.toFixed(0)}%`;
                // Update card in panel
                updateModelCard(modelName, 'downloading', pct, `${dlMb} / ${totalMb} MB`);
                return;
            }
            if (msg.includes('Download started:')) {
                modelDot.className = 'dot loading';
                modelStatusText.textContent = 'Downloading model‚Ä¶';
                const name = msg.replace(/.*Download started:\s*/, '').replace(/\s*\(.*/, '');
                updateModelCard(name, 'downloading', 0, 'Starting‚Ä¶');
                return;
            }
            if (msg.includes('Download complete:')) {
                modelDot.className = 'dot ready';
                modelStatusText.textContent = 'Models downloaded';
                const name = msg.replace(/.*Download complete:\s*/, '').trim();
                updateModelCard(name, 'downloaded', 100, '');
                // Refresh full data to get path
                fetchModels();
                return;
            }
            if (msg.includes('Download failed:')) {
                modelDot.className = 'dot missing';
                modelStatusText.textContent = 'Download failed';
                const name = msg.replace(/.*Download failed:\s*/, '').trim();
                updateModelCard(name, 'not_downloaded', 0, 'Failed');
                return;
            }
            if (msg.includes('Model already downloaded:')) {
                modelDot.className = 'dot ready';
                modelStatusText.textContent = 'Models downloaded';
                return;
            }
        }

        function updateModelCard(modelName, status, pct, progressText) {
            const idx = modelsData.findIndex(m => m.name === modelName);
            if (idx < 0) return;

            const badge = document.getElementById(`model-badge-${idx}`);
            const progressEl = document.getElementById(`model-progress-${idx}`);
            const bar = document.getElementById(`model-bar-${idx}`);
            const pctEl = document.getElementById(`model-pct-${idx}`);
            const dlBtn = document.getElementById(`model-dl-btn-${idx}`);
            if (!badge) return;

            if (status === 'downloading') {
                badge.className = 'status-badge downloading';
                badge.textContent = `üì• ${pct.toFixed(0)}%`;
                if (dlBtn) { dlBtn.disabled = true; dlBtn.textContent = '‚è≥ Downloading‚Ä¶'; }
                if (progressEl) {
                    progressEl.classList.add('visible');
                    bar.style.width = `${pct}%`;
                    pctEl.textContent = progressText;
                }
            } else if (status === 'downloaded') {
                badge.className = 'status-badge downloaded';
                badge.textContent = '‚úÖ Downloaded';
                if (dlBtn) dlBtn.remove();
                if (progressEl) progressEl.classList.remove('visible');
            } else {
                badge.className = 'status-badge not-downloaded';
                badge.textContent = '‚ùå Not Downloaded';
                if (dlBtn) {
                    const locked = dlBtn.dataset.locked === 'true';
                    dlBtn.disabled = locked;
                    dlBtn.textContent = locked ? 'üîí Token required' : '‚¨á Download';
                }
                if (progressEl) progressEl.classList.remove('visible');
            }
        }

        async function downloadModel(modelName, idx) {
            const btn = document.getElementById(`model-dl-btn-${idx}`);
            if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Starting‚Ä¶'; }
            clientLog(`Requesting download for: ${modelName}`);
            try {
                const resp = await fetch(`/api/models/${encodeURIComponent(modelName)}/download`, { method: 'POST' });
                if (resp.ok) {
                    clientLog(`Download triggered for: ${modelName}`);
                    // The progress will be tracked via log WebSocket messages
                    setTimeout(() => fetchModels(), 2000);
                } else {
                    const err = await resp.json().catch(() => ({}));
                    clientLog(`Download failed for ${modelName}: ${err.error || resp.statusText}`);
                    if (btn) { btn.disabled = false; btn.textContent = '‚¨á Retry'; }
                }
            } catch (e) {
                clientLog(`Download error for ${modelName}: ${e.message}`);
                if (btn) { btn.disabled = false; btn.textContent = '‚¨á Retry'; }
            }
        }

        async function deleteModel(modelName, idx) {
            if (!confirm(`Delete model "${modelName}" and all its files?`)) return;
            const btn = document.getElementById(`model-del-btn-${idx}`);
            if (btn) { btn.disabled = true; btn.textContent = 'üóëÔ∏è Deleting‚Ä¶'; }
            clientLog(`Requesting delete for: ${modelName}`);
            try {
                const resp = await fetch(`/api/models/${encodeURIComponent(modelName)}`, { method: 'DELETE' });
                const data = await resp.json().catch(() => ({}));
                if (resp.ok) {
                    clientLog(`Deleted model: ${modelName}`);
                    fetchModels();
                    checkModelStatus();
                } else {
                    clientLog(`Delete failed for ${modelName}: ${data.error || resp.statusText}`);
                    if (btn) { btn.disabled = false; btn.textContent = 'üóëÔ∏è Delete'; }
                }
            } catch (e) {
                clientLog(`Delete error for ${modelName}: ${e.message}`);
                if (btn) { btn.disabled = false; btn.textContent = 'üóëÔ∏è Delete'; }
            }
        }

        async function checkModelStatus() {
            try {
                const resp = await fetch('/health');
                const data = await resp.json();
                const asrLoaded = data.asr_loaded;
                const asrDownloaded = data.asr_downloaded;

                if (asrLoaded) {
                    modelDot.className = 'dot ready';
                    modelStatusText.textContent = 'ASR model ready';
                } else if (asrDownloaded) {
                    modelDot.className = 'dot ready';
                    modelStatusText.textContent = 'Models downloaded';
                } else {
                    modelDot.className = 'dot missing';
                    modelStatusText.textContent = 'Models not available';
                }
                // Pre-fetch models data
                fetchModels();
            } catch (e) {
                modelDot.className = 'dot missing';
                modelStatusText.textContent = 'Status unavailable';
            }
        }

        function connect() {
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${proto}://${location.host}/ws/voice`);
            ws.onopen = () => {
                statusEl.textContent = 'Connected ‚Äî ready';
                statusEl.className = 'connected';
                clientLog('Voice WebSocket connected');
                sendSmartModeConfig();
                checkModelStatus();
            };
            ws.onclose = () => {
                statusEl.textContent = 'Disconnected ‚Äî reconnecting ‚Ä¶';
                statusEl.className = 'disconnected';
                clientLog('Voice WebSocket disconnected ‚Äî reconnecting‚Ä¶');
                setTimeout(connect, 2000);
            };
            ws.onerror = () => ws.close();
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'transcript') {
                    if (data.transcript) {
                        addMessage('user-text', `üí¨ "${data.transcript}"`);
                    }
                    return;
                }
                if (data.type === 'thinking') {
                    removeThinking();
                    addMessage('thinking', 'ü§î Thinking‚Ä¶');
                    statusEl.textContent = 'Smart Mode ‚Äî thinking ‚Ä¶';
                    return;
                }
                if (data.type === 'response') {
                    removeThinking();
                    const text = data.response || data.transcript || '';
                    if (smartMode && data.response && data.response !== data.transcript) {
                        addMessage('agent', `üß† ${text}`);
                    } else if (text) {
                        addMessage('agent', `üîä You just said: "${data.transcript}"`);
                    }
                    if (data.audio) {
                        playAudio(data.audio);
                    }
                    statusEl.textContent = 'Connected ‚Äî ready';
                    statusEl.className = 'connected';
                    return;
                }
                if (data.transcript) {
                    addMessage('agent', `üîä ${data.transcript}`);
                }
                if (data.audio) {
                    playAudio(data.audio);
                }
                statusEl.textContent = 'Connected ‚Äî ready';
                statusEl.className = 'connected';
            };
        }
        connect();

        function removeThinking() {
            const el = chatBox.querySelector('.msg.thinking');
            if (el) el.remove();
        }

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            const label = document.createElement('div');
            label.className = 'label';
            if (role === 'user') label.textContent = 'You';
            else if (role === 'user-text') label.textContent = 'You said';
            else if (role === 'thinking') label.textContent = 'Agent';
            else label.textContent = 'Agent';
            div.appendChild(label);
            div.appendChild(document.createTextNode(text));
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function playAudio(b64) {
            const audioBytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
            const blob = new Blob([audioBytes], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            audio.play().catch(e => clientLog(`Playback error: ${e.message}`));
        }

        async function startRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') return;
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioCtx = new AudioContext({ sampleRate: 16000 });
            const source = audioCtx.createMediaStreamSource(stream);
            const processor = audioCtx.createScriptProcessor(4096, 1, 1);
            const audioData = [];
            processor.onaudioprocess = (e) => {
                audioData.push(new Float32Array(e.inputBuffer.getChannelData(0)));
            };
            source.connect(processor);
            processor.connect(audioCtx.destination);
            mediaRecorder = { state: 'recording', stop: null };
            mediaRecorder.stop = () => {
                processor.disconnect();
                source.disconnect();
                stream.getTracks().forEach(t => t.stop());
                const totalLength = audioData.reduce((acc, buf) => acc + buf.length, 0);
                const merged = new Float32Array(totalLength);
                let offset = 0;
                for (const buf of audioData) {
                    merged.set(buf, offset);
                    offset += buf.length;
                }
                const wavBlob = encodeWAV(merged, 16000);
                addMessage('user', `üé§ [audio ${(wavBlob.size / 1024).toFixed(1)} KB]`);
                clientLog(`Sending ${(wavBlob.size / 1024).toFixed(1)} KB audio to server`);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(wavBlob);
                }
                audioCtx.close();
            };
            mediaRecorder.start = () => {};
            mediaRecorder.start();
            talkBtn.classList.add('recording');
            statusEl.textContent = 'üî¥ Recording ‚Ä¶';
            statusEl.className = 'recording';
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.state = 'inactive';
                mediaRecorder.stop();
                clientLog('Recording stopped');
            }
            talkBtn.classList.remove('recording');
            statusEl.textContent = 'Processing ‚Ä¶';
            statusEl.className = 'connected';
        }

        function encodeWAV(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            function writeString(offset, str) {
                for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
            }
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + samples.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, samples.length * 2, true);
            for (let i = 0; i < samples.length; i++) {
                const s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return new Blob([buffer], { type: 'audio/wav' });
        }

        talkBtn.addEventListener('mousedown', (e) => { e.preventDefault(); startRecording(); });
        talkBtn.addEventListener('mouseup', (e) => { e.preventDefault(); stopRecording(); });
        talkBtn.addEventListener('mouseleave', () => { if (talkBtn.classList.contains('recording')) stopRecording(); });
        talkBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
        talkBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRecording(); });
    </script>
</body>
</html>
